# Makefile for ASDL sharing tests
#
# COPYRIGHT (c) 2024 The Fellowship of SML/NJ (http://www.smlnj.org)
# All rights reserved.
#
# @configure_input@
#

SHELL =			@SHELL@
@SET_MAKE@

ASDL_LIBDIR =		@ASDL_LIBDIR@

ASDLGEN =		@ASDL_BINDIR@/asdlgen
CXX =			@CXX@
CXXFLAGS =		@CXXFLAGS@
CPPFLAGS =		@CPPFLAGS@ -I@ASDL_INCDIR@
LDFLAGS =		@LDFLAGS@ -L$(ASDL_LIBDIR)
LIBS =			@LIBS@ -lasdl

CXX_SRCS =          	cpp-test.cpp test-spec.cpp
CXX_OBJS =          	$(patsubst %.cpp,%.o,$(CXX_SRCS))

build:		cpp-test sml-test

##### C++ test
#
cpp-test:	$(CXX_OBJS)
	$(CXX) -o $@ $(CXX_OBJS) $(LDFLAGS) $(LIBS)

%.o : %.cpp
	$(CXX) -c $(CPPFLAGS) $(CXXFLAGS) $<

cpp-test.cpp:		cxx-files
test-spec.cpp:		cxx-files

# generate the C++ implementation
#
.PHONY:		cxx-files
cxx-files:	test-spec.asdl
	$(ASDLGEN) c++ test-spec.asdl

##### SML test
#
sml-test:	sml-files

# generate the SML implementation
#
.PHONY:		sml-files
sml-files:	test-spec.asdl
	$(ASDLGEN) sml test-spec.asdl

.PHONY:		build

build:

#################### Cleanup ####################

CLEAN_FILES =		cpp-test \
			$(CXX_OBJS) \
			test-spec.hpp test-spec.cpp

DISTCLEAN_FILES +=      Makefile

DEVCLEAN_FILES =

include @ASDL_MKDIR@/clean-rules.gmk
